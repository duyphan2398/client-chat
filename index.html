<!DOCTYPE html>
<html>
<head>
    <title>Ape Chat Demo</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">

    <link rel="stylesheet" href="./style.css">


    <!--  Document: https://v2.vuejs.org/v2/guide/index.html  -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2.7.14/dist/vue.js"></script>

    <!--  Axios  -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <!-- Sweetalert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.6.1/dist/sweetalert2.all.min.js"></script>

    <!--  SocketIO  -->
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"
            integrity="sha384-/KNQL8Nu5gCHLqwqfQjA689Hhoqgi2S84SNUxC3roTe4EhJ9AfLkp8QiQcU8AMzI"
            crossorigin="anonymous"></script>

</head>
<body>


<main id="app">
    <div class="container-fluid over-loading" v-bind:class="{ 'd-flex': loadingMode}">
        <div class="spinner-border text-dark f"></div>
    </div>


    <div class="container-fluid main-container">
        <div class="row">

            <!--      FIRST COLUMN      -->
            <div class="col-2 auth-column">
                <div class="auth-info">
                    <h1 class="text-center">Auth User</h1>
                    <p>ID: {{ authUser.id}}</p>
                    <p>Email: {{ authUser.email}}</p>
                    <p>Phone: {{ authUser.phone_number}}</p>
                </div>
                <div class="connect-form">
                    <!--[       Connect Form         -->
                    <form id="connect-form">
                        <div class="form-group">
                            <label>Token:</label>
                            <input type="text"
                                   class="form-control"
                                   placeholder="Token"
                                   v-model="token"
                                   :disabled="this.wasConnected"
                                   required>
                        </div>
                        <div class="form-group">
                            <label>Connect Page:</label>
                            <select class="form-control"
                                    v-model="routePrefix"
                                    :disabled="this.wasConnected"
                                    required>
                                <option value="api">Member Pages</option>
                                <option value="supplier-api">Supplier Dashboard</option>
                            </select>
                        </div>

                        <button
                                @click="submitConnectForm"
                                type="button"
                                :disabled="this.wasConnected"
                                class="btn btn-primary">
                            Connect
                        </button>
                    </form>
                    <!--       End Connect Form        ] -->
                </div>
            </div>


            <!--      SECOND COLUMN      -->
            <div class="col-4 room-chat-column">
                <template v-for="room in rooms">
                    <div class="room-item">
                        <div class="room-item-image">
                            <img v-bind:src="room.expert.expert_avatar" alt="Roommate avtar">
                        </div>
                        <div class="room-item-info">
                            <h5>
                                Expert Name: {{ room.expert.name }}
                            </h5>
                            <p>
                                Expert ID: {{ room.expert.id }}
                            </p>
                        </div>
                    </div>
                </template>
            </div>
        </div>
    </div>
    <div>
    </div>
</main>
<script type="module">
    // [--------------------------  ENV VARIABLES --------------------------------
    const server_url = 'http://localhost:3000';
    const locale = 'zho';
    // --------------------------  ENV VARIABLES --------------------------------]








    // [--------------------------  SOCKET INIT --------------------------------

    // --------------------------  SOCKET INIT --------------------------------]









    // [--------------------------  SETUP ALERT --------------------------------
    const Toast = Swal.mixin({
        toast: true,
        position: 'top-end',
        showConfirmButton: false,
        timer: 8000,
        timerProgressBar: true
    })

    const showSuccessAlert = (message) => {
        Toast.fire({
            icon: 'success',
            title: message || 'Successfully'
        })
    }

    const showErrorAlert = (error) => {
        Toast.fire({
            icon: 'error',
            title: error || 'Something went wrong !'
        })
    }

    // --------------------------  SETUP ALERT --------------------------------]









    // [--------------------------  SETUP AXIOS INSTANCE --------------------------------
    const axiosService = axios.create();

    axiosService.defaults.baseURL = server_url
    axiosService.defaults.timeout = 5000;
    axiosService.defaults.headers.common['Accept'] = 'application/json'
    axiosService.defaults.headers.common['Content-Type'] = 'application/json'
    axiosService.defaults.headers.common['X-Requested-With'] = 'XMLHttpRequest'
    axiosService.defaults.headers.common['Access-Control-Allow-Origin'] = '*'

    // Add a request interceptor
    axiosService.interceptors.request.use(function (config) {

        // Config language
        config.headers['Accept-Language'] = locale
        return config;
    });

    // Add a request interceptor
    // Add a response interceptor
    axiosService.interceptors.response.use(
        (response) => {
            const statusCode = response.data.code

            if (statusCode === 401) {
                showErrorAlert(response.data.message || 'Authentication Error')
                return Promise.reject(response)
            }

            if (statusCode === 400) {
                showErrorAlert(response.data.message || 'Bad Request')
                return Promise.reject(response)
            }

            if ([403, 404, 429].includes(statusCode)) {
                showErrorAlert(response.data.message || 'Something Went Wrong')
                return Promise.reject(response)
            }

            return response
        },

        (error) => {
            showErrorAlert(error || 'Server Error')
            return Promise.reject(error)
        });
    // --------------------------  SETUP AXIOS INSTANCE --------------------------------]









    // [-------------------------- MAIN CHAT FUNCTION --------------------------------
    document.addEventListener("DOMContentLoaded", () => {
        new Vue({
            el: '#app',
            data: {
                loadingMode: false,

                // APIS
                endpoints: {
                    api: {
                        profile: '/api/members/profile',


                        room_chat_list: '/api/room-chats'

                    },

                    'supplier-api': {
                        profile: '/supplier-api/suppliers/profile',


                        room_chat_list: '/supplier-api/room-chats'
                    }
                },

                // Auth variables
                token: '',
                routePrefix: 'api',
                wasConnected: false,
                authUser: {},

                // Socket variables
                socket: {},

                // Chat variable
                rooms: []
            },

            methods: {
                async submitConnectForm() {
                    if (this.token) {
                        this.loadingMode = true
                        try {
                            const connectEndPoint = this.endpoints[this.routePrefix]['profile']

                            const response = await axiosService.get(connectEndPoint, {headers: {'Authorization': this.token}})
                            this.authUser = response.data.data
                            showSuccessAlert('Connect successfully')

                            // Init Socket
                            this.initSocket()

                            this.wasConnected = true;
                        } catch (e) {
                            console.log(e)
                        }

                        this.loadingMode = false
                    } else {
                        showErrorAlert('Please Fill Full Fields')
                    }
                },

                initSocket() {
                   this.socket = io(server_url+'/api-chat', {
                       auth: {...this.authUser},
                       extraHeaders: {
                           Authorization: this.token
                       }
                   });

                    this.socket.on("throw-exception", (e) => {
                        showErrorAlert(e)
                    });

                    this.socket.on("load-rooms", (rooms) => {
                        this.rooms = rooms
                    });

                }
            }
        })
    });
    // [-------------------------- MAIN CHAT FUNCTION --------------------------------]
</script>
</body>
</html>
